{% extends "base.html" %}

{% block header_actions %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-success btn-sm" id="downloadAllBtn">
            <i class="bi bi-cloud-download me-1"></i>Aggiorna Tutti
        </button>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTickerModal">
            <i class="bi bi-plus-circle me-1"></i>Nuovo Ticker
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshStatusBtn">
            <i class="bi bi-arrow-clockwise me-1"></i>Aggiorna Stato
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Ticker Configurati
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTickers">
                                {{ tickers|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Ticker Aggiornati
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="updatedTickers">
                                {{ ticker_status|selectattr('needs_update', 'equalto', false)|list|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Da Aggiornare
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingTickers">
                                {{ ticker_status|selectattr('needs_update', 'equalto', true)|list|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Ultimo Aggiornamento
                            </div>
                            <div class="small mb-0 font-weight-bold text-gray-800">
                                {% if last_config_update %}
                                    {{ last_config_update[:16] }}
                                {% else %}
                                    Mai
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-event text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Section -->
    <div class="card shadow mb-4" id="quickAddCard">
        <div class="card-header bg-primary text-white">
            <h6 class="m-0">‚ö° Aggiungi Ticker Rapidamente</h6>
        </div>
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-8">
                    <label for="quickTickerInput" class="form-label">Simbolo Ticker</label>
                    <input type="text" class="form-control" id="quickTickerInput" 
                           placeholder="es. AAPL, MSFT, GOOGL..." 
                           style="text-transform: uppercase;">
                    <div class="form-text">
                        Inserisci ticker separati da virgola per aggiungerne multipli: AAPL,MSFT,GOOGL
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-primary w-100" id="quickAddBtn">
                        <i class="bi bi-plus-circle me-1"></i>Aggiungi
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="addPopularBtn">
                    üìà Aggiungi Popolari (AAPL, MSFT, GOOGL, TSLA, AMZN)
                </button>
                <button type="button" class="btn btn-outline-info btn-sm me-2" id="showExamplesBtn">
                    üí° Esempi Ticker
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" id="testConnectionBtn">
                    üîß Test Connessione
                </button>
                <button type="button" class="btn btn-outline-success btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#uploadCsvModal">
                    üìÅ Upload CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Ticker Management Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Gestione Ticker</h6>
            <div class="dropdown no-arrow">
                <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical text-gray-400"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-right shadow">
                    <div class="dropdown-header">Azioni:</div>
                    <a class="dropdown-item" href="#" id="exportConfigBtn">
                        <i class="bi bi-download me-2"></i>Esporta Configurazione
                    </a>
                    <a class="dropdown-item" href="#" id="clearCacheBtn">
                        <i class="bi bi-trash me-2"></i>Pulisci Cache
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if ticker_status %}
                <!-- Table Controls -->
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="tickerSearchInput" 
                                   placeholder="Cerca ticker, nome azienda, settore...">
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    id="clearSearchBtn"
                                    title="Pulisci ricerca">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            Ricerca in tempo reale - <span id="searchResults">{{ ticker_status|length }} ticker trovati</span>
                        </small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end align-items-center">
                            <label for="pageSize" class="form-label me-2 mb-0">Per pagina:</label>
                            <select class="form-select" id="pageSize" style="width: auto;">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tickersTable">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable" data-column="ticker">
                                    Ticker 
                                    <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                                </th>
                                <th class="sortable" data-column="name">
                                    Nome 
                                    <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                                </th>
                                <th>Periodo Dati</th>
                                <th class="sortable" data-column="records">
                                    Record 
                                    <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                                </th>
                                <th>File Dimensioni</th>
                                <th class="sortable" data-column="status">
                                    Stato 
                                    <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                                </th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tickersTableBody">
                            {% for ticker in ticker_status %}
                                <tr data-ticker="{{ ticker.ticker }}" 
                                    data-name="{{ ticker.name }}" 
                                    data-records="{{ ticker.total_records }}"
                                    data-sector="{{ ticker.csv_info.sector if ticker.csv_info else ticker.info.sector if ticker.info else '' }}"
                                    data-industry="{{ ticker.csv_info.industry if ticker.csv_info else ticker.info.industry if ticker.info else '' }}"
                                    data-status="{% if ticker.needs_update %}pending{% elif ticker.files_exist.adjusted and ticker.files_exist.not_adjusted %}updated{% elif ticker.files_exist.adjusted or ticker.files_exist.not_adjusted %}partial{% else %}missing{% endif %}">
                                    <td>
                                        <strong class="ticker-symbol">{{ ticker.ticker }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="company-name">{{ ticker.name }}</span>
                                            {% if ticker.csv_info %}
                                                <div class="small text-success sector-info">
                                                    <i class="bi bi-file-earmark-text me-1"></i>{{ ticker.csv_info.sector }}
                                                </div>
                                                <div class="small text-muted industry-info">
                                                    {{ ticker.csv_info.industry }}
                                                </div>
                                            {% elif ticker.info %}
                                                <div class="small text-info sector-info">
                                                    <i class="bi bi-building me-1"></i>{{ ticker.info.sector }}
                                                </div>
                                                <div class="small text-muted industry-info">
                                                    {{ ticker.info.industry }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if ticker.last_close_date and ticker.first_date %}
                                            <div class="small">
                                                <div><strong>{{ ticker.first_date }}</strong></div>
                                                <div class="text-muted">‚Üì</div>
                                                <div><strong>{{ ticker.last_close_date }}</strong></div>
                                            </div>
                                        {% elif ticker.last_close_date %}
                                            <div class="small">
                                                <div class="text-muted">Da: N/A</div>
                                                <div><strong>{{ ticker.last_close_date }}</strong></div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info record-count">{{ ticker.total_records }}</span>
                                    </td>
                                    <td>
                                        {% if ticker.file_sizes %}
                                            <div class="small">
                                                <div>üìä Adj: {{ ticker.file_sizes.adjusted }}</div>
                                                <div>üìã Raw: {{ ticker.file_sizes.not_adjusted }}</div>
                                            </div>
                                        {% else %}
                                            <small class="text-muted">N/A</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ticker.needs_update %}
                                            <span class="badge bg-warning status-badge">‚è∞ Da aggiornare</span>
                                        {% elif ticker.files_exist.adjusted and ticker.files_exist.not_adjusted %}
                                            <span class="badge bg-success status-badge">‚úÖ 2 Versioni</span>
                                        {% elif ticker.files_exist.adjusted or ticker.files_exist.not_adjusted %}
                                            <span class="badge bg-warning status-badge">‚ö†Ô∏è Parziale</span>
                                        {% else %}
                                            <span class="badge bg-danger status-badge">‚ùå Mancante</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary download-ticker-btn" 
                                                    data-ticker="{{ ticker.ticker }}"
                                                    title="Scarica/Aggiorna">
                                                <i class="bi bi-cloud-download"></i>
                                            </button>
                                            <button class="btn btn-outline-info view-ticker-btn" 
                                                    data-ticker="{{ ticker.ticker }}"
                                                    title="Visualizza Info">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger remove-ticker-btn" 
                                                    data-ticker="{{ ticker.ticker }}"
                                                    title="Rimuovi">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <small class="text-muted">
                            Mostrando <span id="showingFrom">1</span> - <span id="showingTo">10</span> 
                            di <span id="totalRows">{{ ticker_status|length }}</span> ticker
                            <span id="filteredInfo"></span>
                        </small>
                    </div>
                    <nav aria-label="Paginazione ticker">
                        <ul class="pagination pagination-sm mb-0" id="paginationNav">
                            <!-- Pagination buttons will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>

                <!-- No Results Message -->
                <div id="noResultsMessage" class="text-center py-4 d-none">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h5 class="mt-3">Nessun ticker trovato</h5>
                    <p class="text-muted">
                        Prova a modificare i criteri di ricerca o 
                        <button class="btn btn-link p-0" id="resetSearchBtn">cancella il filtro</button>.
                    </p>
                </div>

            {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h5 class="mt-3">Nessun ticker configurato</h5>
                    <p class="text-muted">
                        Inizia aggiungendo il primo ticker per scaricare dati finanziari da Yahoo Finance.
                    </p>
                    <button class="btn btn-primary" id="addFirstTickerBtn">
                        <i class="bi bi-plus-circle me-2"></i>Aggiungi Primo Ticker
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Log Attivit√† Download</h6>
        </div>
        <div class="card-body">
            <div id="downloadLog" class="activity-log" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted py-3">
                    <i class="bi bi-clock-history"></i>
                    <p class="mb-0">Le attivit√† di download verranno mostrate qui...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload CSV Modal -->
    <div class="modal fade" id="uploadCsvModal" tabindex="-1" aria-labelledby="uploadCsvModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadCsvModalLabel">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>Upload File CSV
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Seleziona File CSV</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                        <div class="form-text">
                            Il CSV deve contenere le colonne: Ticker, Company, Sector, Industry
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="downloadData">
                            <label class="form-check-label" for="downloadData">
                                Scarica automaticamente i dati dopo l'importazione
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="replaceExisting">
                            <label class="form-check-label" for="replaceExisting">
                                Sostituisci ticker esistenti
                            </label>
                        </div>
                    </div>

                    <!-- CSV Preview -->
                    <div id="csvPreview" class="d-none">
                        <h6>Anteprima CSV:</h6>
                        <div id="csvStats" class="mb-2"></div>
                        <div class="table-responsive" style="max-height: 200px;">
                            <table class="table table-sm table-bordered">
                                <thead id="csvPreviewHeader"></thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="d-none">
                        <h6>Progresso Upload:</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatus" class="small text-muted">Preparazione...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="confirmUploadCsv">
                        <i class="bi bi-upload me-1"></i>Carica CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Ticker Modal -->
    <div class="modal fade" id="addTickerModal" tabindex="-1" aria-labelledby="addTickerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTickerModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Aggiungi Nuovo Ticker
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalTickerInput" class="form-label">Simbolo Ticker</label>
                        <input type="text" class="form-control" id="modalTickerInput" 
                               placeholder="es. AAPL" style="text-transform: uppercase;">
                        <div class="form-text">
                            Inserisci il simbolo del ticker come mostrato su Yahoo Finance
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" id="confirmAddTicker">
                        <i class="bi bi-plus-circle me-1"></i>Aggiungi Ticker
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Ticker Details Modal -->
    <div class="modal fade" id="viewTickerModal" tabindex="-1" aria-labelledby="viewTickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="viewTickerModalLabel">
                        <i class="bi bi-eye me-2"></i>Dettagli Ticker: <span id="modalTickerSymbol">-</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading State -->
                    <div id="modalLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <p class="mt-2 text-muted">Caricamento dettagli...</p>
                    </div>

                    <!-- Content -->
                    <div id="modalContent" class="d-none">
                        <!-- Company Info -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h6 class="text-primary mb-3">üìä Informazioni Azienda</h6>
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h5 id="modalCompanyName" class="card-title mb-2">-</h5>
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <small class="text-muted">Settore:</small>
                                                <div id="modalSector" class="fw-bold">-</div>
                                            </div>
                                            <div class="col-sm-6">
                                                <small class="text-muted">Industria:</small>
                                                <div id="modalIndustry" class="fw-bold">-</div>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-sm-6">
                                                <small class="text-muted">Exchange:</small>
                                                <div id="modalExchange" class="fw-bold">-</div>
                                            </div>
                                            <div class="col-sm-6">
                                                <small class="text-muted">Valuta:</small>
                                                <div id="modalCurrency" class="fw-bold">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-primary mb-3">üéØ Stato Ticker</h6>
                                <div class="text-center">
                                    <div id="modalStatusBadge" class="badge bg-secondary fs-6 mb-2">-</div>
                                    <div id="modalStatusIcon" class="display-1">üìà</div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Statistics -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">üìà Statistiche Dati</h6>
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white text-center">
                                            <div class="card-body py-2">
                                                <div class="fs-4 fw-bold" id="modalTotalRecords">0</div>
                                                <div class="small">Record Totali</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white text-center">
                                            <div class="card-body py-2">
                                                <div class="fs-6 fw-bold" id="modalFirstDate">-</div>
                                                <div class="small">Prima Data</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white text-center">
                                            <div class="card-body py-2">
                                                <div class="fs-6 fw-bold" id="modalLastDate">-</div>
                                                <div class="small">Ultima Data</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white text-center">
                                            <div class="card-body py-2">
                                                <div class="fs-6 fw-bold" id="modalDataSpan">-</div>
                                                <div class="small">Periodo (anni)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">üíæ Informazioni File</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">üìä File Adjusted</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="fw-bold" id="modalAdjustedSize">-</div>
                                                        <small class="text-muted">Prezzi aggiustati</small>
                                                    </div>
                                                    <div id="modalAdjustedStatus" class="fs-4">‚ùì</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">üìã File Raw</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="fw-bold" id="modalNotAdjustedSize">-</div>
                                                        <small class="text-muted">Prezzi originali</small>
                                                    </div>
                                                    <div id="modalNotAdjustedStatus" class="fs-4">‚ùì</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Import Information -->
                        <div id="modalImportInfo" class="row mb-4 d-none">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">üìÅ Informazioni Importazione</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted">Importato da CSV:</small>
                                                <div id="modalImportDate" class="fw-bold">-</div>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">Ultimo aggiornamento:</small>
                                                <div id="modalLastUpdated" class="fw-bold">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historical Data Table -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">üìä Dati Storici Recenti</h6>
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Ultimi 20 giorni di trading</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="dataVersion" id="adjustedRadio" checked>
                                                <label class="btn btn-outline-primary" for="adjustedRadio">Adjusted</label>
                                                
                                                <input type="radio" class="btn-check" name="dataVersion" id="rawRadio">
                                                <label class="btn btn-outline-secondary" for="rawRadio">Raw</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Loading per tabella -->
                                        <div id="tableLoading" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            <small class="text-muted ms-2">Caricamento dati...</small>
                                        </div>
                                        
                                        <!-- Tabella dati -->
                                        <div id="historicalDataContainer" class="d-none">
                                            <div class="table-responsive" style="max-height: 400px;">
                                                <table class="table table-hover table-sm mb-0">
                                                    <thead class="table-light sticky-top">
                                                        <tr>
                                                            <th>Data</th>
                                                            <th class="text-end">Open</th>
                                                            <th class="text-end">High</th>
                                                            <th class="text-end">Low</th>
                                                            <th class="text-end">Close</th>
                                                            <th class="text-end" id="adjCloseHeader">Adj Close</th>
                                                            <th class="text-end">Volume</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="historicalDataBody">
                                                        <!-- Dati verranno inseriti qui -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card-footer bg-light">
                                                <small class="text-muted">
                                                    üí° <span id="dataVersionNote">Prezzi aggiustati per splits e dividendi</span>
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <!-- Errore caricamento dati -->
                                        <div id="tableError" class="text-center py-3 d-none">
                                            <i class="bi bi-exclamation-triangle text-warning"></i>
                                            <small class="text-muted ms-2">Errore nel caricamento dei dati storici</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">‚ö° Azioni Rapide</h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-success" id="modalDownloadBtn">
                                        <i class="bi bi-cloud-download me-1"></i>Aggiorna Dati
                                    </button>
                                    <button class="btn btn-info" id="modalViewFilesBtn">
                                        <i class="bi bi-folder-open me-1"></i>Esplora File
                                    </button>
                                    <button class="btn btn-warning" id="modalExportBtn">
                                        <i class="bi bi-download me-1"></i>Esporta Info
                                    </button>
                                    <button class="btn btn-outline-danger" id="modalDeleteBtn">
                                        <i class="bi bi-trash me-1"></i>Rimuovi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<!-- JavaScript modules for data management - versione SEMPLIFICATA -->
<!-- IMPORTANTE: l'ordine √® importante ma non serve sincronizzazione complessa -->

<script>
console.log('üîÑ Inizio caricamento moduli JavaScript semplificati...');
</script>

<!-- STEP 1: API Core - deve essere caricato per primo -->
<script src="{{ url_for('static', filename='js/ticker-api.js') }}"></script>

<!-- STEP 2: Moduli dipendenti da TickerAPI (versioni semplici) -->
<script src="{{ url_for('static', filename='js/ticker-table.js') }}"></script>
<script src="{{ url_for('static', filename='js/ticker-modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/csv-upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/smart-status.js') }}"></script>

<!-- STEP 3: Manager principale - deve essere caricato per ultimo -->
<script src="{{ url_for('static', filename='js/data-management.js') }}"></script>

<script>
// Verifica finale che tutto sia caricato correttamente
setTimeout(() => {
    console.log('üß™ Test finale moduli:');
    console.log('- TickerAPI disponibile:', !!window.TickerAPI);
    console.log('- TickerAPI.addTicker funzione:', typeof window.TickerAPI?.addTicker === 'function');
    console.log('- DataManagementInstance:', !!window.DataManagementInstance);
    console.log('- TickerTableInstance:', !!window.TickerTableInstance);
    
    if (window.TickerAPI && typeof window.TickerAPI.addTicker === 'function') {
        console.log('‚úÖ Tutti i moduli caricati correttamente - Sistema pronto!');
    } else {
        console.warn('‚ö†Ô∏è Alcuni moduli potrebbero avere problemi');
    }
}, 1000);

console.log('‚úÖ Script di caricamento moduli semplificato completato');
</script>
{% endblock %}