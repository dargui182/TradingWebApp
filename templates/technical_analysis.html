<!-- ===== FILE: templates/technical_analysis.html ===== -->
{% extends "base.html" %}

{% block header_actions %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-success btn-sm" id="runAnalysisBtn">
            <i class="bi bi-play-circle me-1"></i>Esegui Analisi
        </button>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>Opzioni
            </button>
            <ul class="dropdown-menu">
                <li><h6 class="dropdown-header">Fonte Dati</h6></li>
                <li><a class="dropdown-item" href="#" data-source="adjusted">üìä Adjusted (raccomandato)</a></li>
                <li><a class="dropdown-item" href="#" data-source="notadjusted">üìã Not Adjusted</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Tipo Analisi</h6></li>
                <li><a class="dropdown-item" href="#" data-analysis="both">üéØ Completa</a></li>
                <li><a class="dropdown-item" href="#" data-analysis="sr">üìè Solo S/R</a></li>
                <li><a class="dropdown-item" href="#" data-analysis="skorupinski">üé¢ Solo Skorupinski</a></li>
            </ul>
        </div>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshSummaryBtn">
            <i class="bi bi-arrow-clockwise me-1"></i>Aggiorna
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Ticker Analizzati
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAnalyzedTickers">
                                {{ summary.support_resistance.analyzed + summary.skorupinski_zones.analyzed }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-graph-up text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Supporti/Resistenze
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSRLevels">
                                {{ summary.support_resistance.total_levels }}
                            </div>
                            <div class="small text-muted">{{ summary.support_resistance.analyzed }} ticker</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-diagram-3 text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Zone Supply
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSupplyZones">
                                {{ summary.skorupinski_zones.supply_zones }}
                            </div>
                            <div class="small text-muted">üî¥ RBD, DBD</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-down-circle text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Zone Demand
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDemandZones">
                                {{ summary.skorupinski_zones.demand_zones }}
                            </div>
                            <div class="small text-muted">üü¢ DBR, RBR</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-arrow-up-circle text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Data Source Indicator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>Fonte Dati Attuale:</strong> 
                    <span id="currentDataSource">ADJUSTED</span> - 
                    <span id="dataSourceDescription">Prezzi aggiustati per splits e dividendi (raccomandato per analisi tecnica)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="analysisNavTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="bi bi-speedometer2 me-1"></i>Panoramica
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart" type="button" role="tab">
                        <i class="bi bi-graph-up me-1"></i>Grafico Interattivo
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="zones-tab" data-bs-toggle="tab" data-bs-target="#zones" type="button" role="tab">
                        <i class="bi bi-layers me-1"></i>Zone Skorupinski
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="levels-tab" data-bs-toggle="tab" data-bs-target="#levels" type="button" role="tab">
                        <i class="bi bi-diagram-3 me-1"></i>Supporti/Resistenze
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="analysisTabContent">
                
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">üéØ Metodologia Skorupinski</h5>
                            <p class="text-muted">
                                Identificazione di zone Supply/Demand basata sui pattern di Bernd Skorupinski:
                            </p>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-danger">üî¥ SUPPLY ZONES</h6>
                                            <div class="mb-2">
                                                <span class="badge bg-danger me-1">RBD</span>
                                                <span class="badge bg-dark">DBD</span>
                                            </div>
                                            <small class="text-muted">Rise-Base-Drop<br>Drop-Base-Drop</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-success">üü¢ DEMAND ZONES</h6>
                                            <div class="mb-2">
                                                <span class="badge bg-success me-1">DBR</span>
                                                <span class="badge bg-primary">RBR</span>
                                            </div>
                                            <small class="text-muted">Drop-Base-Rise<br>Rise-Base-Rise</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">üìè Supporti e Resistenze</h5>
                            <p class="text-muted">
                                Analisi classica di supporti e resistenze basata su:
                            </p>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-check-circle text-success me-2"></i>Pattern di minimi/massimi locali</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Conteggio tocchi e forza livelli</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Distanza dinamica tra livelli</li>
                                <li><i class="bi bi-check-circle text-success me-2"></i>Analisi volume (se disponibile)</li>
                            </ul>
                            
                            <div class="card bg-light mt-3">
                                <div class="card-body">
                                    <h6 class="card-title">‚öôÔ∏è Parametri Analisi</h6>
                                    <div class="small">
                                        <div>üìÖ Periodo: Ultimi {{ summary.get('max_years_lookback', 5) }} anni</div>
                                        <div>üéØ Forza minima: {{ summary.get('min_zone_strength', 1) }} tocchi</div>
                                        <div>üìä Impulso minimo: {{ summary.get('min_impulse_pct', 1.2) }}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">‚ö° Azioni Rapide</h5>
                            <div class="d-grid gap-2 d-md-flex">
                                <button class="btn btn-primary" id="runFullAnalysisBtn">
                                    <i class="bi bi-play-circle me-1"></i>Analisi Completa
                                </button>
                                <button class="btn btn-outline-success" id="runSROnlyBtn">
                                    <i class="bi bi-diagram-3 me-1"></i>Solo S/R
                                </button>
                                <button class="btn btn-outline-info" id="runSkorupinkiOnlyBtn">
                                    <i class="bi bi-layers me-1"></i>Solo Skorupinski
                                </button>
                                <button class="btn btn-outline-warning" id="exportAnalysisBtn">
                                    <i class="bi bi-download me-1"></i>Esporta Risultati
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Chart Tab CON ZONA LEGGENDA MIGLIORATA -->
                <div class="tab-pane fade" id="chart" role="tabpanel">
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <!-- Controlli esistenti del grafico -->
                            <div class="card">
                                <div class="card-body">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-4">
                                            <label for="chartTickerSelect" class="form-label">Seleziona Ticker</label>
                                            <select class="form-select" id="chartTickerSelect">
                                                <option value="">-- Seleziona un ticker --</option>
                                                {% for ticker in tickers %}
                                                <option value="{{ ticker }}">{{ ticker }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="chartDaysSelect" class="form-label">Giorni di Storico</label>
                                            <select class="form-select" id="chartDaysSelect">
                                                <option value="30">30 giorni</option>
                                                <option value="60">60 giorni</option>
                                                <option value="100" selected>100 giorni</option>
                                                <option value="200">200 giorni</option>
                                                <option value="365">1 anno</option>
                                                <option value="730">2 anni</option>
                                                <option value="1095">3 anni</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Opzioni Grafico</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showSRLevels" checked>
                                                <label class="form-check-label" for="showSRLevels">
                                                    Supporti/Resistenze
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="showZones" checked>
                                                <label class="form-check-label" for="showZones">
                                                    Zone Skorupinski
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <!-- NUOVO: Controlli Zone -->
                                            <div class="btn-group-vertical w-100">
                                                <button class="btn btn-outline-info btn-sm" id="toggleZoneLegend"
                                                        data-bs-toggle="tooltip" title="Mostra/Nascondi Leggenda Zone">
                                                    <i class="bi bi-list-ul"></i> Leggenda
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="loadChartBtn">
                                                    <i class="bi bi-arrow-clockwise"></i> Aggiorna
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- NUOVO: Pannello informazioni zone migliorato -->
                            <div class="card zone-info-card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="card-title mb-0">üéØ Zone Skorupinski</h6>
                                </div>
                                <div class="card-body py-3">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="zone-counter">
                                                <span class="badge bg-success badge-lg" id="demandZoneCount">0</span>
                                                <small class="text-muted d-block mt-1">Demand</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="zone-counter">
                                                <span class="badge bg-danger badge-lg" id="supplyZoneCount">0</span>
                                                <small class="text-muted d-block mt-1">Supply</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="zone-counter">
                                                <span class="badge bg-secondary badge-lg" id="totalZoneCount">0</span>
                                                <small class="text-muted d-block mt-1">Totale</small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-secondary btn-sm" id="zoneConfigBtn"
                                                data-bs-toggle="modal" data-bs-target="#zoneConfigModal">
                                            <i class="bi bi-gear"></i> Config
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" id="toggleAllZonesBtn">
                                            <i class="bi bi-eye"></i> Toggle All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="chartTitle">Seleziona un ticker per visualizzare il grafico</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="exportChartBtn">
                                    <i class="bi bi-download"></i> Esporta
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="fullscreenChartBtn">
                                    <i class="bi bi-arrows-fullscreen"></i> Fullscreen
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Chart Loading -->
                            <div id="chartLoading" class="text-center py-5 d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Caricamento...</span>
                                </div>
                                <p class="mt-2 text-muted">Caricamento dati grafico...</p>
                            </div>
                            
                            <!-- Chart Canvas -->
                            <div id="chartContainer" style="height: 700px;">
                                <div id="technicalChart" style="height: 600px; width: 100%;"></div>
                            </div>
                            
                            <!-- Chart Info -->
                            <div id="chartInfo" class="mt-3 d-none">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="text-primary">üìä Dati Prezzo</h6>
                                        <div class="small" id="priceInfo">
                                            <!-- Price info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-success">üìè Supporti/Resistenze</h6>
                                        <div class="small" id="srInfo">
                                            <!-- S/R info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-info">üéØ Zone Skorupinski</h6>
                                        <div class="small" id="zonesInfo">
                                            <!-- Zones info will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Zone Skorupinski Tab con tooltip -->
                <div class="tab-pane fade" id="zones" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">üéØ Zone Skorupinski</h5>
                        <button class="btn btn-sm btn-outline-primary" id="refreshZonesBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>Aggiorna
                        </button>
                    </div>
                    
                    <!-- Controlli Filtri e Ricerca Zone -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="zonesTickerFilter" 
                                               placeholder="Cerca per ticker (es. AAPL, MSFT...)">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="zonesTypeFilter">
                                        <option value="">Tutti i tipi</option>
                                        <option value="Supply">Solo Supply</option>
                                        <option value="Demand">Solo Demand</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="zonesPatternFilter">
                                        <option value="">Tutti i pattern</option>
                                        <option value="RBD">RBD</option>
                                        <option value="DBD">DBD</option>
                                        <option value="DBR">DBR</option>
                                        <option value="RBR">RBR</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearZonesFilters">
                                        <i class="bi bi-x-circle me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info e Paginazione Zone -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted" id="zonesTableInfo">
                            Mostrando 0 di 0 zone
                        </small>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">Righe per pagina:</small>
                            <select class="form-select form-select-sm" id="zonesPageSize" style="width: auto;">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Tabella Zone con Tooltip -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="zonesTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-column="ticker" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìä Simbolo del titolo azionario (es. AAPL per Apple Inc.)">
                                        Ticker <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="date"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìÖ Data di formazione della zona Skorupinski">
                                        Data <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="pattern"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üéØ Tipo di pattern: RBD (Rise-Base-Drop), DBD (Drop-Base-Drop), DBR (Drop-Base-Rise), RBR (Rise-Base-Rise)">
                                        Pattern <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="type"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="‚ö° Tipo di zona: Supply (venditori attivi) o Demand (compratori attivi)">
                                        Tipo <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìè Range di prezzi che compone la zona (Minimo - Massimo)">
                                        Zona
                                    </th>
                                    <th class="sortable" data-column="zone_center"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üéØ Prezzo centrale della zona (punto medio tra minimo e massimo)">
                                        Centro <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="zone_thickness_pct"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìê Spessore della zona come percentuale del prezzo (zone sottili sono pi√π precise)">
                                        Spessore <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="strength_score"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üí™ Punteggio di forza della zona (0-10): considera volume, velocit√† impulso e qualit√† pattern">
                                        Forza <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="distance_from_current"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìç Distanza percentuale dal prezzo corrente del titolo (+/- %)">
                                        Distanza % <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üîß Azioni disponibili: visualizza grafico, analizza dettagli">
                                        Azioni
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="zonesTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginazione Zone -->
                    <nav aria-label="Paginazione zone">
                        <ul class="pagination pagination-sm justify-content-center" id="zonesPagination">
                            <!-- Populated by JavaScript -->
                        </ul>
                    </nav>
                </div>

                <!-- Support/Resistance Tab con tooltip -->
                <div class="tab-pane fade" id="levels" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">üìè Livelli Supporti e Resistenze</h5>
                        <button class="btn btn-sm btn-outline-primary" id="refreshLevelsBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>Aggiorna
                        </button>
                    </div>
                    
                    <!-- Controlli Filtri e Ricerca Livelli -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="levelsTickerFilter" 
                                               placeholder="Cerca per ticker (es. AAPL, MSFT...)">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="levelsTypeFilter">
                                        <option value="">Tutti i tipi</option>
                                        <option value="Support">Solo Supporti</option>
                                        <option value="Resistance">Solo Resistenze</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="range" class="form-range" id="levelsStrengthFilter" 
                                           min="0" max="10" step="0.5" value="0"
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="üí™ Filtra per forza minima del livello (0 = tutti, 10 = solo i pi√π forti)">
                                    <small class="text-muted">Forza min: <span id="strengthValue">0</span></small>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearLevelsFilters">
                                        <i class="bi bi-x-circle me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info e Paginazione Livelli -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted" id="levelsTableInfo">
                            Mostrando 0 di 0 livelli
                        </small>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">Righe per pagina:</small>
                            <select class="form-select form-select-sm" id="levelsPageSize" style="width: auto;">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Tabella Livelli con Tooltip -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="levelsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-column="ticker"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìä Simbolo del titolo azionario (es. AAPL per Apple Inc.)">
                                        Ticker <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="date"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìÖ Data di formazione del livello di supporto o resistenza">
                                        Data <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="type"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="‚ö° Tipo: Support (supporto, livello di rimbalzo) o Resistance (resistenza, livello di respinta)">
                                        Tipo <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="level"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üí∞ Prezzo esatto del livello di supporto o resistenza">
                                        Livello <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="strength"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üí™ Forza del livello (1-10): considera numero tocchi, volume e recency">
                                        Forza <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="touches"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üëÜ Numero di volte che il prezzo ha toccato questo livello (pi√π tocchi = pi√π significativo)">
                                        Tocchi <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="days_from_end"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìÖ Giorni trascorsi dalla formazione del livello (livelli recenti sono pi√π rilevanti)">
                                        Giorni Formazione <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="avg_range"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üìä Range medio giornaliero del titolo (High - Low medio) durante l'analisi">
                                        Range Medio <i class="bi bi-arrow-down-up sort-icon"></i>
                                    </th>
                                    <th data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="üîß Azioni disponibili: visualizza grafico, analizza dettagli">
                                        Azioni
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="levelsTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginazione Livelli -->
                    <nav aria-label="Paginazione livelli">
                        <ul class="pagination pagination-sm justify-content-center" id="levelsPagination">
                            <!-- Populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Log Attivit√† Analisi</h6>
        </div>
        <div class="card-body">
            <div id="analysisLog" class="activity-log" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted py-3">
                    <i class="bi bi-clock-history"></i>
                    <p class="mb-0">Le attivit√† di analisi verranno mostrate qui...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NUOVO: Leggenda Zone Mobile -->
    <div id="zone-legend-container" class="zone-legend-panel d-none">
        <!-- Contenuto generato dinamicamente via JavaScript -->
    </div>

    <!-- NUOVO: Modal Configurazione Zone -->
    <div class="modal fade" id="zoneConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚öôÔ∏è Configurazione Zone Skorupinski</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üü¢ Zone Demand</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showDemandLabels" checked>
                                <label class="form-check-label" for="showDemandLabels">
                                    Mostra etichette prezzi
                                </label>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">Opacit√†:</label>
                                <input type="range" class="form-range" id="demandOpacity" 
                                       min="10" max="80" value="20" step="10">
                                <small class="text-muted">20%</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>üî¥ Zone Supply</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showSupplyLabels" checked>
                                <label class="form-check-label" for="showSupplyLabels">
                                    Mostra etichette prezzi
                                </label>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">Opacit√†:</label>
                                <input type="range" class="form-range" id="supplyOpacity" 
                                       min="10" max="80" value="20" step="10">
                                <small class="text-muted">20%</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6>üéØ Filtri Zone</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Distanza massima:</label>
                                    <select class="form-select form-select-sm" id="maxDistanceFilter">
                                        <option value="">Tutte le zone</option>
                                        <option value="5">Entro 5%</option>
                                        <option value="10">Entro 10%</option>
                                        <option value="20">Entro 20%</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Forza minima:</label>
                                    <select class="form-select form-select-sm" id="minStrengthFilter">
                                        <option value="">Tutte le forze</option>
                                        <option value="5">Forza ‚â• 5</option>
                                        <option value="7">Forza ‚â• 7</option>
                                        <option value="8">Forza ‚â• 8</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="applyZoneConfig">Applica</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<!-- Plotly.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>

<!-- Technical Analysis JavaScript - ORDINE IMPORTANTE! -->
<script src="{{ url_for('static', filename='js/enhacedTableManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/technical-analysis.js') }}"></script>

<script>
// INIZIALIZZAZIONE PRINCIPALE TECHNICAL ANALYSIS
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inizializzazione Technical Analysis Dashboard...');
    
    // Verifica librerie necessarie
    if (typeof Plotly === 'undefined') {
        console.error('‚ùå Plotly.js non caricato');
        return;
    }
    
    if (typeof EnhancedTableManager === 'undefined') {
        console.error('‚ùå EnhancedTableManager non caricato');
        return;
    }
    
    // Verifica pagina corretta
    if (!document.getElementById('analysisNavTabs')) {
        console.log('‚ÑπÔ∏è Pagina Technical Analysis non rilevata');
        return;
    }
    
    // Crea istanza manager principale
    if (!window.taManager) {
        window.taManager = new TechnicalAnalysisManager();
        window.TechnicalAnalysisInstance = window.taManager;
    }
    
    // Event listeners per controlli zone
    setupZoneControls();
    
    console.log('‚úÖ Technical Analysis Manager inizializzato completamente');
});

// FUNZIONE PER CONFIGURARE CONTROLLI ZONE
function setupZoneControls() {
    // Toggle leggenda
    const toggleLegendBtn = document.getElementById('toggleZoneLegend');
    if (toggleLegendBtn) {
        toggleLegendBtn.addEventListener('click', function() {
            const legendContainer = document.getElementById('zone-legend-container');
            if (legendContainer) {
                legendContainer.classList.toggle('d-none');
                
                // Cambia icona del bottone
                const icon = this.querySelector('i');
                if (legendContainer.classList.contains('d-none')) {
                    icon.className = 'bi bi-list-ul';
                    this.innerHTML = '<i class="bi bi-list-ul"></i> Leggenda';
                } else {
                    icon.className = 'bi bi-x-lg';
                    this.innerHTML = '<i class="bi bi-x-lg"></i> Chiudi';
                }
            }
        });
    }
    
    // Toggle tutte le zone
    const toggleAllBtn = document.getElementById('toggleAllZonesBtn');
    if (toggleAllBtn) {
        toggleAllBtn.addEventListener('click', function() {
            if (typeof window.toggleAllZones === 'function') {
                window.toggleAllZones();
            }
        });
    }
    
    // Configurazione zone modal
    const applyConfigBtn = document.getElementById('applyZoneConfig');
    if (applyConfigBtn) {
        applyConfigBtn.addEventListener('click', function() {
            const demandOpacity = document.getElementById('demandOpacity')?.value || 20;
            const supplyOpacity = document.getElementById('supplyOpacity')?.value || 20;
            const maxDistance = document.getElementById('maxDistanceFilter')?.value;
            const minStrength = document.getElementById('minStrengthFilter')?.value;
            
            // Applica configurazioni
            if (window.taManager && typeof window.taManager.applyZoneConfiguration === 'function') {
                window.taManager.applyZoneConfiguration({
                    demandOpacity: demandOpacity,
                    supplyOpacity: supplyOpacity,
                    maxDistance: maxDistance,
                    minStrength: minStrength
                });
            }
            
            // Chiudi modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('zoneConfigModal'));
            if (modal) modal.hide();
        });
    }
}

// FUNZIONE PER AGGIORNARE CONTATORI ZONE
window.updateZoneCounts = function(zoneLegendData) {
    if (!zoneLegendData) return;
    
    const demandCount = zoneLegendData.filter(z => z.type === 'Demand').length;
    const supplyCount = zoneLegendData.filter(z => z.type === 'Supply').length;
    const totalCount = demandCount + supplyCount;
    
    const demandCountEl = document.getElementById('demandZoneCount');
    const supplyCountEl = document.getElementById('supplyZoneCount');
    const totalCountEl = document.getElementById('totalZoneCount');
    
    if (demandCountEl) {
        demandCountEl.textContent = demandCount;
        demandCountEl.classList.add('animate-update');
        setTimeout(() => demandCountEl.classList.remove('animate-update'), 300);
    }
    if (supplyCountEl) {
        supplyCountEl.textContent = supplyCount;
        supplyCountEl.classList.add('animate-update');
        setTimeout(() => supplyCountEl.classList.remove('animate-update'), 300);
    }
    if (totalCountEl) {
        totalCountEl.textContent = totalCount;
        totalCountEl.classList.add('animate-update');
        setTimeout(() => totalCountEl.classList.remove('animate-update'), 300);
    }
};

// FUNZIONI GLOBALI PER ZONE
window.toggleZoneVisibility = function(zoneId, isVisible) {
    if (window.taManager && typeof window.taManager.toggleZoneVisibility === 'function') {
        window.taManager.toggleZoneVisibility(zoneId, isVisible);
    }
};

window.toggleAllZones = function() {
    const checkboxes = document.querySelectorAll('#zone-legend-container .zone-checkbox');
    if (checkboxes.length === 0) return;
    
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const newState = !allChecked;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked !== newState) {
            checkbox.checked = newState;
            const zoneId = checkbox.getAttribute('data-zone-id');
            window.toggleZoneVisibility(zoneId, newState);
        }
    });
};

console.log('‚úÖ Technical Analysis Dashboard completo caricato');
</script>

{% endblock %}